\encoding win1251

begin;

select createTempTables();
select setCurrentDl(4);

select setAsNotLogging(1);
select setAsNotLogging(2);

\i ./functions/misc/f_safe_drop_trigger.sql
\i ./functions/misc/f_create_trigger.sql
\i ./functions/misc/f_is_table_exist.sql


--In readd_functions this calls does not invoked
--So, we should to invoke that here
\i ./functions/general/generateuid.sql
\i ./functions/io_objects/triggers/readd_triggers.sql
\i ./functions/inf_exchange/createtriggers.sql

\i ./functions/io_objects/checkioforowner.sql



select setAsLogging(1);
select setAsLogging(2);


\i ./functions/readd_functions.sql
\i ./functions/security/readd_security.sql

\i ./functions/tasks/zarya22/readd_zarya_func.sql

--СЮДА (МЕЖДУ УДАЛЕНИЕМ И СОЗДАНИЕМ ТРИГГЕРА) ПОМЕЩАЕМ ЗАПРОСЫ НА СОЗДАНИЕ КАТЕГОРИЙ (ДОБАВЛЯТЬ СТРОКИ В ACCESS_CATEGORIES_TABLE НЕ НАДО)
select f_safe_drop_trigger('trgcheckcatforglobal', 'io_categories');

insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-177', 177, 10, NULL, false, 'Типы показателей', 'SYSCATEGORY_177', NULL::varchar, true, true, 1);
insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-178', 178, 8, 177, true, 'Справочник типов показателей', 'SYSCATEGORY_178', NULL::varchar, true, true, 1);

insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-179', 179, 10, NULL, false, 'Показатели', 'SYSCATEGORY_179', NULL::varchar, true, true, 1);
insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-180', 180, 8, 179, true, 'Справочник показателей', 'SYSCATEGORY_180', NULL::varchar, true, true, 1);

insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-181', 181, 10, NULL, false, 'Значения показателей', 'SYSCATEGORY_181', NULL::varchar, true, true, 1);
insert into io_categories (unique_id, id, id_io_type, id_child, is_main, name, code, description, is_system, is_global, id_io_state) values ('localorg-categories-182', 182, 8, 181, true, 'Справочник значений показателей', 'SYSCATEGORY_182', NULL::varchar, true, true, 1);

select f_create_trigger('trgcheckcatforglobal', 'before', 'insert or update', 'io_categories', 'checkcatforglobal()');

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (177, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (177, 2, 1);

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (178, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (178, 2, 1);

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (179, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (179, 2, 1);

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (180, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (180, 2, 1);

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (181, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (181, 2, 1);

insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (182, 1, 2);
insert into io_life_cycle (id_io_category, id_state_src, id_state_dest) values (182, 2, 1);

insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-291', 291, 2, 'id_indicator_type', 'Тип показателя', 'Тип показателя', 'indicator_type', 'name', 150, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-292', 292, 2, 'id_io_object', 'Объект', 'Объект', 'io_objects', 'name', 150, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-293', 293, 2, 'id_io_object_src', 'Информацию передал', 'Информацию передал', 'io_objects', 'name', 150, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-294', 294, 2, 'id_io_object_src1', 'За кого передал', 'За кого передал', 'io_objects', 'name', 150, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-295', 295, 5, 'meas_time', 'Время измерения', 'Время измерения', NULL, NULL, 120, TRUE);
--insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-295', 295, 5, 'meas_time', 'Время измерения', 'Время измерения', NULL, NULL, 120, TRUE);
--insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-296', 296, 9, 'value', 'Значение', 'Значение', NULL, NULL, 150, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-297', 297, 5, 'start_time', 'Актуален с', 'Актуален с', NULL, NULL, 120, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-298', 298, 5, 'stop_time', 'Актуален по', 'Актуален по', NULL, NULL, 120, TRUE);
insert into attributes (unique_id, id, id_a_type, code, name, title, table_name, column_name, def_width, is_system) values('localorg-attributes-299', 299, 2, 'id_indicator', 'Индикатор', 'Индикатор', 'indicator', 'name', 150, TRUE);


--таблица типов показателей
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (177, 1, NULL, true, true); --id
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (177, 2, NULL, true, false); --name

--таблица показателей
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 1, NULL, true, true); --id
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 2, NULL, true, false); --name
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 3, NULL, false, false); --desc
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 291, NULL, true, false); --id_indicator_type
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 27, NULL, false, false); --id_parent
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 5, NULL, true, false); --id_a_type
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 8, NULL, false, false); --table_name
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (179, 9, NULL, false, false); --column_name

--таблица значений показателей
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 1, NULL, true, true); --id
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 286, NULL, true, false); --the_value
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 292, NULL, true, false); --id_io_object
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 293, NULL, false, false); --id_io_object_src
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 294, NULL, false, false); --id_io_object_src1
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 295, NULL, true, false); --meas_time
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 16, NULL, true, false); --insert_time
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 297, NULL, true, false); --start_time
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 298, NULL, false, false); --stop_time
insert into attrs_categories (id_io_category, id_io_attribute, def_value, is_mandatory, is_read_only) values (181, 299, NULL, true, false); --id_indicator

--СЮДА (МЕЖДУ УДАЛЕНИЕМ И СОЗДАНИЕМ ТРИГГЕРОВ) ПОМЕЩАЕМ ЗАПРОСЫ НА СОЗДАНИЕ ИО (НАДО ДОБАВЛЯТЬ СТРОКИ В ACCESS_TABLE)
select f_safe_drop_trigger('trgioinsert', 'io_objects');
select f_safe_drop_trigger('zz_trgzioinserttableafter', 'io_objects');
insert into tbl_io_objects (unique_id, id, id_io_category, author, id_io_state, name, table_name, description, information, is_system, is_global, id_sync_type, insert_time, id_maclabel, id_owner_org)
values ('localorg-io_objects-86', 86, 178, 1, 1, 'Справочник типов показателей', 'indicator_type', NULL, 'Системный объект', true, true, 5, current_timestamp, 1, NULL);
insert into access_table (id_io_object, id_role, allow_readlist, allow_read, allow_delete, allow_update)
values (86, -10, TRUE, TRUE, FALSE, FALSE);

insert into tbl_io_objects (unique_id, id, id_io_category, author, id_io_state, name, table_name, description, information, is_system, is_global, id_sync_type, insert_time, id_maclabel, id_owner_org)
values ('localorg-io_objects-87', 87, 180, 1, 1, 'Справочник показателей', 'indicator', NULL, 'Системный объект', true, true, 5, current_timestamp, 1, NULL);
insert into access_table (id_io_object, id_role, allow_readlist, allow_read, allow_delete, allow_update)
values (87, -10, TRUE, TRUE, FALSE, FALSE);

insert into tbl_io_objects (unique_id, id, id_io_category, author, id_io_state, name, table_name, description, information, is_system, is_global, id_sync_type, insert_time, id_maclabel, id_owner_org)
values ('localorg-io_objects-88', 88, 182, 1, 1, 'Справочник значений показателей', 'indicators_values', NULL, 'Системный объект', true, true, 5, current_timestamp, 1, NULL);
insert into access_table (id_io_object, id_role, allow_readlist, allow_read, allow_delete, allow_update)
values (88, -10, TRUE, TRUE, FALSE, FALSE);

select f_create_trigger('trgioinsert', 'before', 'insert or update', 'io_objects', 'ioinsertcheck()');
select f_create_trigger('zz_trgzioinserttableafter', 'after', 'insert', 'io_objects', 'ioinsertchecktableafter()');

create table indicator (
   id                   SERIAL               not null,
   id_indicator_type    INT4                 not null,
   id_parent            INT4                 null,
   id_a_type            INT4                 not null,
   name                 VARCHAR              not null,
   description          VARCHAR              null,
   constraint PK_INDICATOR primary key (id)
)
inherits (root_table);

comment on table indicator is
'фБВМЙГБ РПЛБЪБФЕМЕК ЙОЖПТНБГЙПООЩИ ПВЯЕЛФПЧ.
дМС УППФЧЕФУФЧЙС НПДЕМЙ ъБТС22 ЧЧЕДЕО ФБЛПК ФЙР ЙОЖПТНБГЙЙ ЛБЛ РПЛБЪБФЕМЙ ЙОЖПТНБГЙПООЩИ ПВЯЕЛФПЧ.
пФМЙЮБАФУС ПФ ПВЩЮОЩИ БФТЙВХФПЧ ФЕН, ЮФП ЙНЕАФ ОБВПТ ВПМЕЕ ТБУЫЙТЕООЩИ ИБТБЛФЕТЙУФЙЛ. б ФБЛЦЕ УПИТБОСАФ ЙУФПТЙА ЪОБЮЕОЙК';

select setMacToNULL('indicator');
select createTriggerUID('indicator');

create table indicator_type (
   id                   SERIAL               not null,
   name                 VARCHAR              null,
   constraint PK_INDICATOR_TYPE primary key (id)
)
inherits (root_table);

select setMacToNULL('indicator_type');
select createTriggerUID('indicator_type');

create table indicators_values (
   id                   SERIAL               not null,
   id_io_object         INT4                 not null,
   id_indicator         INT4                 not null,
   id_io_object_src     INT4                 null,
   id_io_object_src1    INT4                 null,
   meas_time            TIMESTAMP            not null,
   insert_time          TIMESTAMP            not null,
   the_value            VARCHAR              not null,
   start_time           TIMESTAMP            not null,
   stop_time            TIMESTAMP            null
)
inherits (root_table);

comment on table indicators_values is
'ъОБЮЕОЙС РПЛБЪБФЕМЕК ДМС ЙОЖПТНБГЙПООЩИ ПВЯЕЛФПЧ';

comment on column indicators_values.id_io_object_src is
'йДЕОФЙЖЙЛБФПТ йп, ЛПФПТЩК СЧЙМУС ЙУФПЮОЙЛПН ЙОЖПТНБГЙЙ П ЪОБЮЕОЙЙ РПЛБЪБФЕМС.';

comment on column indicators_values.id_io_object_src1 is
'йДЕОФЙЖЙЛБФПТ ПВЯЕЛФБ, ЪБ ЛПЗП РЕТЕДБМЙ ЙОЖПТНБГЙА. еУМЙ ЙУФПЮОЙЛ РЕТЕДБЈФ ЙОЖПТНБГЙА УБН ЪБ УЕВС, ФП ЪОБЮЕОЙЕ Ч ЬФПН РПМЕ УПЧРБДБЕФ УП ЪОБЮЕОЙЕН Ч РПМЕ <йУФПЮОЙЛ>';

comment on column indicators_values.meas_time is
'дБФБ Й ЧТЕНС ЙЪНЕТЕОЙС ЪОБЮЕОЙС РПЛБЪБФЕМС';

comment on column indicators_values.insert_time is
'дБФБ Й ЧТЕНС ДПЧЕДЕОЙС ЪОБЮЕОЙС РПЛБЪБФЕМС Ч УЙУФЕНХ';

comment on column indicators_values.the_value is
'ъОБЮЕОЙЕ РПЛБЪБФЕМС';

comment on column indicators_values.start_time is
'дБФБ Й ЧТЕНС ОБЮБМБ БЛФХБМШОПУФЙ РПЛБЪБФЕМС';

comment on column indicators_values.stop_time is
'дБФБ Й ЧТЕНС ПЛПОЮБОЙС БЛФХБМШОПУФЙ РПЛБЪБФЕМС';

select setMacToNULL('indicators_values');
select createTriggerUID('indicators_values');

alter table indicator
   add constraint FK_INDICATO_REFERENCE_INDICATO foreign key (id_indicator_type)
      references indicator_type (id)
      on delete restrict on update restrict;

alter table indicator
   add constraint FK_INDICATO_REFERENCE_PARENT foreign key (id_parent)
      references indicator (id)
      on delete restrict on update restrict;

alter table indicator
   add constraint FK_INDICATO_REFERENCE_A_TYPES foreign key (id_a_type)
      references a_types (id)
      on delete restrict on update restrict;

alter table indicators_values
   add constraint FK_INDICATO_REFERENCE_IO_OBJEC foreign key (id_io_object)
      references tbl_io_objects (id)
      on delete restrict on update restrict;

alter table indicators_values
   add constraint FK_INDICATOR_IO_OBJECT foreign key (id_indicator)
      references indicator (id)
      on delete restrict on update restrict;

alter table indicators_values
   add constraint FK_INDICATO_IO_OBJECT_SRC foreign key (id_io_object_src)
      references tbl_io_objects (id)
      on delete restrict on update restrict;

alter table indicators_values
   add constraint FK_INDICATO_IO_OBJECT_SRC1 foreign key (id_io_object_src1)
      references tbl_io_objects (id)
      on delete restrict on update restrict;

--ВСЕ ОСТАЛЬНОЕ ЗДЕСЬ


commit;
